<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marais | A New Orleans Art House</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loader" id="loader">
        <div class="loader-content">
            <span class="loader-location">New Orleans</span>
            <h1 class="loader-title">Marais</h1>
            <div class="loader-line"></div>
        </div>
    </div>

    <!-- Image Lightbox -->
    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" id="lightbox-close">&times;</button>
        <button class="lightbox-prev" id="lightbox-prev">&#8249;</button>
        <button class="lightbox-next" id="lightbox-next">&#8250;</button>
        <div class="lightbox-content">
            <img src="" alt="" id="lightbox-img">
        </div>
    </div>

    <!-- Minimal Navigation - Appears on scroll -->
    <nav class="nav-minimal" id="nav">
        <a href="#" class="nav-logo">Marais</a>
        <div class="nav-right">
            <a href="#book" class="nav-book-btn">Reserve</a>
        </div>
    </nav>

    <!-- Scene 1: The Invitation -->
    <section class="scene scene-invitation" id="home">
        <div class="invitation-bg">
            <div class="invitation-overlay"></div>
        </div>
        <!-- Animated Egret Painting -->
        <div class="egret-animation">
            <img src="Copy of 1.jpg" alt="Egret Painting" class="egret-painting">
        </div>
        <div class="invitation-content">
            <span class="invitation-location">New Orleans, Louisiana</span>
            <h1 class="invitation-title">Marais</h1>
            <p class="invitation-subtitle">Where Art Lives</p>
            <div class="invitation-scroll">
                <span>Enter</span>
                <div class="scroll-arrow"></div>
            </div>
        </div>
    </section>

    <!-- Scene 2: The Art - Egret Reveal -->
    <section class="scene scene-art" id="art">
        <div class="art-container">
            <div class="art-frame">
                <img src="Copy of 1.jpg" alt="Louisiana Egret" class="art-image">
            </div>
            <div class="art-text">
                <span class="scene-label">The Art</span>
                <h2>Every wall tells a story</h2>
                <p>Original Louisiana artwork adorns this home—from the hand-painted egret watching over the living room to murals of moss-draped oaks. This isn't a rental. It's a gallery you can sleep in.</p>
            </div>
        </div>
    </section>

    <!-- Scene 3: The Space - Living Areas -->
    <section class="scene scene-space" id="space">
        <div class="space-gallery">
            <div class="space-image space-image-main">
                <img src="Copy of 3.jpg" alt="Living Space">
            </div>
            <div class="space-image space-image-secondary">
                <img src="Copy of 6.jpg" alt="Interior Detail">
            </div>
        </div>
        <div class="space-content">
            <span class="scene-label">The Space</span>
            <h2>Five bedrooms.<br>Endless light.</h2>
            <p>Soaring ceilings, walls of glass, and a layout designed for gathering. Modern architecture meets Southern warmth—every corner invites you to stay a while.</p>
        </div>
    </section>

    <!-- Scene 4: The Water - Pool Paradise -->
    <section class="scene scene-water" id="water">
        <div class="water-bg">
            <img src="Copy of 50.jpg" alt="Pool">
        </div>
        <div class="water-overlay"></div>
        <div class="water-content">
            <span class="scene-label">The Water</span>
            <h2>Your private paradise</h2>
            <p>A heated pool for every season. A tiki bar for every mood. Tropical gardens, outdoor speakers, and evenings that stretch into New Orleans nights.</p>
        </div>
    </section>

    <!-- Scene 5: The Layout - Floor Plan -->
    <section class="scene scene-layout" id="layout">
        <div class="layout-container">
            <div class="layout-text">
                <span class="scene-label">The Layout</span>
                <h2>Room to roam</h2>
                <p>Two floors of thoughtfully designed space. Five bedrooms with king and queen beds, open living areas, and seamless flow between indoors and out.</p>
            </div>
            <div class="layout-image">
                <img src="2300 floor sketch.jpg" alt="Floor Plan">
            </div>
        </div>
    </section>

    <!-- Scene 6: The Details - Horizontal Scroll -->
    <section class="scene scene-details" id="details">
        <div class="details-header">
            <span class="scene-label">The Details</span>
            <h2>Everything you need, nothing you don't</h2>
        </div>
        <div class="details-scroll-container">
            <div class="details-track">
                <div class="detail-card">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                        </svg>
                    </div>
                    <h3>5 Bedrooms</h3>
                    <p>King beds, luxury linens, room to breathe</p>
                </div>
                <div class="detail-card">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
                        </svg>
                    </div>
                    <h3>Heated Pool</h3>
                    <p>Year-round swimming under Louisiana skies</p>
                </div>
                <div class="detail-card">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                        </svg>
                    </div>
                    <h3>Indoor/Outdoor Sound</h3>
                    <p>Speakers throughout for your soundtrack</p>
                </div>
                <div class="detail-card">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <h3>Sleeps 10</h3>
                    <p>Gather the whole crew</p>
                </div>
                <div class="detail-card">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"/>
                            <circle cx="12" cy="12" r="4"/>
                        </svg>
                    </div>
                    <h3>Tiki Bar</h3>
                    <p>Mix drinks, make memories</p>
                </div>
                <div class="detail-card">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="2" y="7" width="20" height="14" rx="2"/>
                            <path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/>
                        </svg>
                    </div>
                    <h3>Work-Ready</h3>
                    <p>Fast WiFi, dedicated workspace</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Scene 6: The Neighborhood -->
    <section class="scene scene-neighborhood" id="neighborhood">
        <div class="neighborhood-grid">
            <div class="neighborhood-image">
                <img src="nola-magazine.jpg" alt="Magazine Street">
            </div>
            <div class="neighborhood-content">
                <span class="scene-label">The Neighborhood</span>
                <h2>Steps from Magazine Street</h2>
                <p>You're in the Irish Channel—one of New Orleans' most vibrant neighborhoods. Walk to world-class restaurants, dive bars, antique shops, and live music. The French Quarter is a short streetcar ride away.</p>
                <div class="neighborhood-highlights">
                    <div class="highlight">
                        <span class="highlight-distance">2 min walk</span>
                        <span class="highlight-name">Magazine Street</span>
                    </div>
                    <div class="highlight">
                        <span class="highlight-distance">10 min</span>
                        <span class="highlight-name">Garden District</span>
                    </div>
                    <div class="highlight">
                        <span class="highlight-distance">15 min</span>
                        <span class="highlight-name">French Quarter</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Scene 7: The Gallery - More Images -->
    <section class="scene scene-gallery" id="gallery">
        <div class="gallery-header">
            <span class="scene-label">The Gallery</span>
            <h2>See more</h2>
        </div>
        <div class="gallery-mosaic">
            <div class="mosaic-item mosaic-large">
                <img src="Copy of 45.jpg" alt="Pool deck">
            </div>
            <div class="mosaic-item">
                <img src="Copy of 10.jpg" alt="Bedroom">
            </div>
            <div class="mosaic-item">
                <img src="Copy of 17.jpg" alt="Kitchen">
            </div>
            <div class="mosaic-item mosaic-tall">
                <img src="Copy of 21.jpg" alt="Bathroom">
            </div>
            <div class="mosaic-item">
                <img src="Copy of 35.jpg" alt="Outdoor">
            </div>
            <div class="mosaic-item mosaic-wide">
                <img src="Copy of 40.jpg" alt="Evening">
            </div>
            <div class="mosaic-item">
                <img src="Copy of 28.jpg" alt="Detail">
            </div>
            <div class="mosaic-item">
                <img src="Copy of 32.jpg" alt="Living">
            </div>
        </div>
    </section>

    <!-- Scene 8: Guest Reviews -->
    <section class="scene scene-reviews" id="reviews">
        <div class="reviews-container">
            <div class="reviews-header">
                <span class="scene-label">Guest Stories</span>
                <h2>What people are saying</h2>
            </div>
            <div class="reviews-grid">
                <div class="review-card">
                    <div class="review-stars">★★★★★</div>
                    <p class="review-text">"Absolutely stunning home. The artwork throughout made it feel like staying in a gallery. The pool was perfect and Magazine Street is right there. We didn't want to leave."</p>
                    <div class="review-author">
                        <span class="review-name">Sarah M.</span>
                        <span class="review-date">October 2024</span>
                    </div>
                </div>
                <div class="review-card">
                    <div class="review-stars">★★★★★</div>
                    <p class="review-text">"Best Airbnb we've ever stayed in. The space is incredible - those high ceilings and the indoor/outdoor flow. Had 8 people and everyone had room to spread out. The tiki bar was a hit!"</p>
                    <div class="review-author">
                        <span class="review-name">James & Co.</span>
                        <span class="review-date">September 2024</span>
                    </div>
                </div>
                <div class="review-card">
                    <div class="review-stars">★★★★★</div>
                    <p class="review-text">"We came for Jazz Fest and this was the perfect home base. The neighborhood is wonderful - walkable to so much. The heated pool after long festival days was everything."</p>
                    <div class="review-author">
                        <span class="review-name">The Wilsons</span>
                        <span class="review-date">May 2024</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Scene 9: Book Your Stay -->
    <section class="scene scene-book" id="book">
        <div class="book-container">
            <div class="book-intro">
                <span class="scene-label">Your Stay</span>
                <h2>Ready to experience Marais?</h2>
                <p>Select your dates and we'll show you the rest.</p>
            </div>

            <div class="book-widget">
                <div class="book-card">
                    <div class="book-inputs">
                        <div class="book-field">
                            <label for="check-in">Arrive</label>
                            <input type="date" id="check-in" name="check-in">
                        </div>
                        <div class="book-field">
                            <label for="check-out">Depart</label>
                            <input type="date" id="check-out" name="check-out">
                        </div>
                        <div class="book-field">
                            <label for="guests">Guests</label>
                            <select id="guests" name="guests">
                                <option value="1">1 Guest</option>
                                <option value="2" selected>2 Guests</option>
                                <option value="3">3 Guests</option>
                                <option value="4">4 Guests</option>
                                <option value="5">5 Guests</option>
                                <option value="6">6 Guests</option>
                                <option value="7">7 Guests</option>
                                <option value="8">8 Guests</option>
                                <option value="9">9 Guests</option>
                                <option value="10">10 Guests</option>
                            </select>
                        </div>
                        <button type="button" id="check-prices-btn" class="btn-primary">
                            Check Availability
                        </button>
                    </div>

                    <!-- Quote Display -->
                    <div class="quote-display hidden" id="quote-display">
                        <div class="quote-loading" id="quote-loading">
                            <div class="loading-spinner"></div>
                            <span>Finding your rate...</span>
                        </div>
                        <div class="quote-result hidden" id="quote-result">
                            <div class="quote-summary">
                                <div class="quote-dates" id="quote-dates"></div>
                                <div class="quote-price">
                                    <span class="price-total" id="quote-total"></span>
                                    <span class="price-breakdown" id="quote-breakdown"></span>
                                </div>
                            </div>
                            <button type="button" id="book-now-btn" class="btn-book-now">
                                Book Now
                            </button>
                        </div>
                        <div class="quote-error hidden" id="quote-error">
                            <p id="quote-error-message"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkout Form (Hidden by default) -->
            <div class="checkout-container hidden" id="checkout-container">
                <div class="checkout-card">
                    <h3>Complete Your Reservation</h3>
                    <div class="checkout-summary" id="checkout-summary"></div>

                    <form id="checkout-form">
                        <div class="form-row">
                            <div class="form-field">
                                <label for="guest-first-name">First Name</label>
                                <input type="text" id="guest-first-name" required>
                            </div>
                            <div class="form-field">
                                <label for="guest-last-name">Last Name</label>
                                <input type="text" id="guest-last-name" required>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="guest-email">Email</label>
                            <input type="email" id="guest-email" required>
                        </div>
                        <div class="form-field">
                            <label for="guest-phone">Phone</label>
                            <input type="tel" id="guest-phone">
                        </div>

                        <div class="form-field">
                            <label>Card Details</label>
                            <div id="card-element"></div>
                            <div id="card-errors" class="card-errors"></div>
                        </div>

                        <label class="checkbox-label">
                            <input type="checkbox" id="accept-terms" required>
                            <span>I agree to the <a href="#" target="_blank">terms</a> and <a href="#" target="_blank">cancellation policy</a></span>
                        </label>

                        <button type="submit" id="submit-booking" class="btn-submit-booking">
                            Confirm Reservation
                        </button>
                    </form>
                </div>
            </div>

            <!-- Booking Confirmation (Hidden by default) -->
            <div class="booking-confirmation hidden" id="booking-confirmation">
                <div class="confirmation-icon">✓</div>
                <h3>You're all set</h3>
                <p>Confirmation details have been sent to your email.</p>
                <div class="confirmation-details" id="confirmation-details"></div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-brand">
                <span class="footer-logo">Marais</span>
                <p>A New Orleans Art House</p>
            </div>
            <div class="footer-links">
                <a href="#art">The Art</a>
                <a href="#space">The Space</a>
                <a href="#water">The Water</a>
                <a href="#neighborhood">Neighborhood</a>
                <a href="#book">Book</a>
            </div>
            <div class="footer-contact">
                <p>New Orleans, Louisiana</p>
                <p>Irish Channel</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Marais. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // ============================================
        // LOADING SCREEN
        // ============================================
        window.addEventListener('load', () => {
            const loader = document.getElementById('loader');
            setTimeout(() => {
                loader.classList.add('loaded');
                document.body.classList.add('page-loaded');
            }, 2000);
        });

        // ============================================
        // LIGHTBOX
        // ============================================
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxClose = document.getElementById('lightbox-close');
        const lightboxPrev = document.getElementById('lightbox-prev');
        const lightboxNext = document.getElementById('lightbox-next');
        let currentImageIndex = 0;
        let galleryImages = [];

        // Collect all gallery images
        document.querySelectorAll('.gallery-mosaic .mosaic-item img, .space-image img').forEach((img, index) => {
            galleryImages.push(img.src);
            img.style.cursor = 'pointer';
            img.addEventListener('click', () => {
                currentImageIndex = index;
                openLightbox(img.src);
            });
        });

        function openLightbox(src) {
            lightboxImg.src = src;
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            lightbox.classList.remove('active');
            document.body.style.overflow = '';
        }

        function showPrevImage() {
            currentImageIndex = (currentImageIndex - 1 + galleryImages.length) % galleryImages.length;
            lightboxImg.src = galleryImages[currentImageIndex];
        }

        function showNextImage() {
            currentImageIndex = (currentImageIndex + 1) % galleryImages.length;
            lightboxImg.src = galleryImages[currentImageIndex];
        }

        lightboxClose.addEventListener('click', closeLightbox);
        lightboxPrev.addEventListener('click', showPrevImage);
        lightboxNext.addEventListener('click', showNextImage);
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) closeLightbox();
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('active')) return;
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') showPrevImage();
            if (e.key === 'ArrowRight') showNextImage();
        });

        // ============================================
        // NAVIGATION
        // ============================================
        const nav = document.getElementById('nav');
        let lastScroll = 0;

        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset;

            // Show nav after scrolling past first scene
            if (currentScroll > window.innerHeight * 0.5) {
                nav.classList.add('visible');
            } else {
                nav.classList.remove('visible');
            }

            lastScroll = currentScroll;
        });

        // ============================================
        // SCROLL ANIMATIONS
        // ============================================
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -10% 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('in-view');
                }
            });
        }, observerOptions);

        // Observe all scenes and animated elements
        document.querySelectorAll('.scene, .animate-in').forEach(el => {
            observer.observe(el);
        });

        // ============================================
        // SMOOTH SCROLL FOR ANCHOR LINKS
        // ============================================
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // ============================================
        // HORIZONTAL SCROLL FOR DETAILS
        // ============================================
        const detailsSection = document.querySelector('.scene-details');
        const detailsTrack = document.querySelector('.details-track');

        if (detailsSection && detailsTrack) {
            // Add horizontal scroll on wheel in details section
            detailsSection.addEventListener('wheel', (e) => {
                if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
                    const container = document.querySelector('.details-scroll-container');
                    container.scrollLeft += e.deltaY;
                }
            }, { passive: true });
        }

        // ============================================
        // BOOKING FUNCTIONALITY
        // ============================================
        const checkInInput = document.getElementById('check-in');
        const checkOutInput = document.getElementById('check-out');
        const guestsSelect = document.getElementById('guests');
        const checkPricesBtn = document.getElementById('check-prices-btn');
        const quoteDisplay = document.getElementById('quote-display');
        const quoteLoading = document.getElementById('quote-loading');
        const quoteResult = document.getElementById('quote-result');
        const quoteError = document.getElementById('quote-error');
        const bookNowBtn = document.getElementById('book-now-btn');
        const checkoutContainer = document.getElementById('checkout-container');

        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        checkInInput.min = today;
        checkOutInput.min = today;

        // Update checkout min date when check-in changes
        checkInInput.addEventListener('change', () => {
            const checkInDate = new Date(checkInInput.value);
            checkInDate.setDate(checkInDate.getDate() + 1);
            checkOutInput.min = checkInDate.toISOString().split('T')[0];
            if (checkOutInput.value && checkOutInput.value <= checkInInput.value) {
                checkOutInput.value = '';
            }
        });

        // Store quote data
        let currentQuote = null;

        // Check prices
        checkPricesBtn.addEventListener('click', async () => {
            const checkIn = checkInInput.value;
            const checkOut = checkOutInput.value;
            const guests = guestsSelect.value;

            if (!checkIn || !checkOut) {
                alert('Please select check-in and check-out dates');
                return;
            }

            // Show loading
            quoteDisplay.classList.remove('hidden');
            quoteLoading.classList.remove('hidden');
            quoteResult.classList.add('hidden');
            quoteError.classList.add('hidden');

            try {
                const response = await fetch(`/.netlify/functions/get-quote?checkIn=${checkIn}&checkOut=${checkOut}&guests=${guests}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Unable to get quote');
                }

                currentQuote = data;
                console.log('Quote response:', JSON.stringify(data, null, 2));

                // Format dates
                const checkInDate = new Date(checkIn + 'T00:00:00');
                const checkOutDate = new Date(checkOut + 'T00:00:00');
                const nights = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));

                const dateOptions = { month: 'short', day: 'numeric' };
                const formattedCheckIn = checkInDate.toLocaleDateString('en-US', dateOptions);
                const formattedCheckOut = checkOutDate.toLocaleDateString('en-US', dateOptions);

                // Display quote - try multiple paths to find total
                document.getElementById('quote-dates').textContent = `${formattedCheckIn} - ${formattedCheckOut} · ${nights} night${nights > 1 ? 's' : ''}`;

                // Guesty quote response structure: rates.ratePlans[0].money
                const ratePlan = data.rates?.ratePlans?.[0];
                const money = ratePlan?.money;

                // Get total price (hostPayout includes everything guest pays)
                const total = money?.hostPayout
                    || money?.totalPrice
                    || money?.fareAccommodation
                    || 0;

                console.log('Money object:', money);
                console.log('Extracted total:', total);

                // Store ratePlanId for booking
                if (ratePlan?.ratePlan?._id) {
                    currentQuote.ratePlanId = ratePlan.ratePlan._id;
                }
                document.getElementById('quote-total').textContent = `$${Math.round(total).toLocaleString()}`;
                document.getElementById('quote-breakdown').textContent = 'total including fees & taxes';

                quoteLoading.classList.add('hidden');
                quoteResult.classList.remove('hidden');

            } catch (error) {
                console.error('Quote error:', error);
                document.getElementById('quote-error-message').textContent = error.message || 'Unable to get pricing. Please try again.';
                quoteLoading.classList.add('hidden');
                quoteError.classList.remove('hidden');
            }
        });

        // Book Now - Show checkout form
        bookNowBtn.addEventListener('click', () => {
            checkoutContainer.classList.remove('hidden');
            checkoutContainer.scrollIntoView({ behavior: 'smooth' });
            initializeStripe();
        });

        // ============================================
        // STRIPE INTEGRATION
        // ============================================
        let stripe, cardElement;

        function initializeStripe() {
            if (stripe) return; // Already initialized

            stripe = Stripe('pk_live_LKZLJ4NxjahxWDx9hYlD2lNm00ZBKE4pVm');
            const elements = stripe.elements();

            cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#2D2D2D',
                        fontFamily: "'Montserrat', sans-serif",
                        '::placeholder': { color: '#A0A0A0' }
                    }
                }
            });

            cardElement.mount('#card-element');

            cardElement.on('change', (event) => {
                const displayError = document.getElementById('card-errors');
                displayError.textContent = event.error ? event.error.message : '';
            });

            // Populate checkout summary
            const checkIn = checkInInput.value;
            const checkOut = checkOutInput.value;
            const guests = guestsSelect.value;
            const money = currentQuote?.rates?.ratePlans?.[0]?.money;
            const total = money?.hostPayout
                || money?.totalPrice
                || money?.fareAccommodation
                || 0;

            document.getElementById('checkout-summary').innerHTML = `
                <div class="summary-row">
                    <span>Dates</span>
                    <span>${checkIn} to ${checkOut}</span>
                </div>
                <div class="summary-row">
                    <span>Guests</span>
                    <span>${guests}</span>
                </div>
                <div class="summary-row summary-total">
                    <span>Total</span>
                    <span>$${Math.round(total).toLocaleString()}</span>
                </div>
            `;
        }

        // Handle checkout form submission
        const checkoutForm = document.getElementById('checkout-form');
        checkoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submit-booking');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            try {
                // Create payment method
                const { paymentMethod, error } = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        name: `${document.getElementById('guest-first-name').value} ${document.getElementById('guest-last-name').value}`,
                        email: document.getElementById('guest-email').value
                    }
                });

                if (error) {
                    throw new Error(error.message);
                }

                // Create reservation
                const response = await fetch('/.netlify/functions/create-reservation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        quoteId: currentQuote._id || currentQuote.id,
                        ratePlanId: currentQuote.ratePlanId,
                        ccToken: paymentMethod.id,
                        guest: {
                            firstName: document.getElementById('guest-first-name').value,
                            lastName: document.getElementById('guest-last-name').value,
                            email: document.getElementById('guest-email').value,
                            phone: document.getElementById('guest-phone').value
                        }
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Reservation failed');
                }

                // Show confirmation
                checkoutContainer.classList.add('hidden');
                document.getElementById('booking-confirmation').classList.remove('hidden');
                document.getElementById('confirmation-details').innerHTML = `
                    <p><strong>Confirmation:</strong> ${result.reservation.confirmationCode || result.reservation._id}</p>
                    <p><strong>Dates:</strong> ${checkInInput.value} to ${checkOutInput.value}</p>
                `;

            } catch (error) {
                console.error('Booking error:', error);
                alert(error.message || 'Unable to complete booking. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Confirm Reservation';
            }
        });

        // ============================================
        // PARALLAX EFFECTS
        // ============================================
        window.addEventListener('scroll', () => {
            const scrolled = window.pageYOffset;

            // Parallax for invitation background
            const invitationBg = document.querySelector('.invitation-bg');
            if (invitationBg) {
                invitationBg.style.transform = `translateY(${scrolled * 0.5}px)`;
            }

            // Parallax for water background
            const waterBg = document.querySelector('.water-bg img');
            if (waterBg) {
                const waterSection = document.querySelector('.scene-water');
                const waterRect = waterSection.getBoundingClientRect();
                if (waterRect.top < window.innerHeight && waterRect.bottom > 0) {
                    const progress = (window.innerHeight - waterRect.top) / (window.innerHeight + waterRect.height);
                    waterBg.style.transform = `translateY(${progress * -100}px) scale(1.1)`;
                }
            }
        }, { passive: true });
    </script>
</body>
</html>
