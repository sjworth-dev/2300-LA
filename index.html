<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marais | A New Orleans Art House</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loader" id="loader">
        <div class="loader-content">
            <span class="loader-location">New Orleans</span>
            <h1 class="loader-title">Marais</h1>
            <div class="loader-line"></div>
        </div>
    </div>

    <!-- Image Lightbox -->
    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" id="lightbox-close">&times;</button>
        <button class="lightbox-prev" id="lightbox-prev">&#8249;</button>
        <button class="lightbox-next" id="lightbox-next">&#8250;</button>
        <div class="lightbox-content">
            <img src="" alt="" id="lightbox-img">
        </div>
    </div>

    <!-- Minimal Navigation - Appears on scroll -->
    <nav class="nav-minimal" id="nav">
        <a href="#" class="nav-logo">Marais</a>
        <div class="nav-right">
            <a href="#book" class="nav-book-btn">Reserve</a>
        </div>
    </nav>

    <!-- Scene 1: The Invitation -->
    <section class="scene scene-invitation" id="home">
        <div class="invitation-bg">
            <div class="invitation-overlay"></div>
        </div>
        <!-- Animated Egret Painting -->
        <div class="egret-animation">
            <img src="Copy of 1.jpg" alt="Egret Painting" class="egret-painting">
        </div>
        <div class="invitation-content">
            <span class="invitation-location">New Orleans, Louisiana</span>
            <h1 class="invitation-title">Marais</h1>
            <p class="invitation-subtitle">Where Art Lives</p>
            <div class="invitation-scroll">
                <div class="scroll-arrow"></div>
            </div>
        </div>
    </section>

    <!-- Scene 2: Book Your Stay -->
    <section class="scene scene-book" id="book">
        <div class="book-container">
            <div class="book-intro">
                <span class="scene-label">Your Stay</span>
                <h2>Ready to experience Marais?</h2>
                <p>Select your dates and we'll show you the rest.</p>
            </div>

            <div class="book-widget">
                <div class="book-card">
                    <div class="book-inputs">
                        <div class="book-field">
                            <label>Arrive</label>
                            <div class="date-input" id="check-in-display" data-target="check-in">Select date</div>
                            <input type="hidden" id="check-in" name="check-in">
                        </div>
                        <div class="book-field">
                            <label>Depart</label>
                            <div class="date-input" id="check-out-display" data-target="check-out">Select date</div>
                            <input type="hidden" id="check-out" name="check-out">
                        </div>
                        <div class="book-field">
                            <label for="guests">Guests</label>
                            <select id="guests" name="guests">
                                <option value="1">1 Guest</option>
                                <option value="2" selected>2 Guests</option>
                                <option value="3">3 Guests</option>
                                <option value="4">4 Guests</option>
                                <option value="5">5 Guests</option>
                                <option value="6">6 Guests</option>
                                <option value="7">7 Guests</option>
                                <option value="8">8 Guests</option>
                                <option value="9">9 Guests</option>
                                <option value="10">10 Guests</option>
                            </select>
                        </div>
                        <button type="button" id="check-prices-btn" class="btn-primary">
                            Check Availability
                        </button>
                    </div>

                    <!-- Calendar Backdrop -->
                    <div class="calendar-backdrop hidden" id="calendar-backdrop"></div>

                    <!-- Custom Calendar - Full Width Event Calendar -->
                    <div class="calendar-container hidden" id="calendar-container">
                        <div class="calendar-main">
                            <!-- Selection instruction bar -->
                            <div class="calendar-instruction" id="calendar-instruction">
                                <span class="instruction-text">Select your arrival date</span>
                                <button type="button" class="calendar-done-btn hidden" id="calendar-done">Done</button>
                            </div>
                            <div class="calendar-header">
                                <button type="button" class="calendar-nav" id="cal-prev">&#8592;</button>
                                <div class="calendar-titles">
                                    <span class="calendar-title" id="calendar-title-1"></span>
                                    <span class="calendar-title" id="calendar-title-2"></span>
                                </div>
                                <button type="button" class="calendar-nav" id="cal-next">&#8594;</button>
                            </div>
                            <div class="calendar-grid-wrapper">
                                <!-- Month 1 -->
                                <div class="calendar-month">
                                    <div class="calendar-weekdays">
                                        <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
                                    </div>
                                    <div class="calendar-days" id="calendar-days-1"></div>
                                </div>
                                <!-- Month 2 -->
                                <div class="calendar-month">
                                    <div class="calendar-weekdays">
                                        <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
                                    </div>
                                    <div class="calendar-days" id="calendar-days-2"></div>
                                </div>
                            </div>
                            <div class="calendar-legend">
                                <span class="legend-item"><span class="legend-dot festival"></span> Festival</span>
                                <span class="legend-item"><span class="legend-dot parade"></span> Parade</span>
                                <span class="legend-item"><span class="legend-dot secondline"></span> Second Line</span>
                                <span class="legend-item"><span class="legend-dot event"></span> Event</span>
                                <span class="legend-item"><span class="legend-dot unavailable"></span> Booked</span>
                            </div>
                        </div>
                        <div class="calendar-sidebar">
                            <div class="calendar-events" id="calendar-events">
                                <div class="events-header">
                                    <h3>New Orleans Events</h3>
                                    <p class="events-subtitle">What's happening during your stay</p>
                                </div>
                                <div class="events-list" id="events-list"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Quote Display -->
                    <div class="quote-display hidden" id="quote-display">
                        <div class="quote-loading" id="quote-loading">
                            <div class="loading-spinner"></div>
                            <span>Finding your rate...</span>
                        </div>
                        <div class="quote-result hidden" id="quote-result">
                            <div class="quote-summary">
                                <div class="quote-dates" id="quote-dates"></div>
                                <div class="quote-price">
                                    <span class="price-total" id="quote-total"></span>
                                    <span class="price-breakdown" id="quote-breakdown"></span>
                                </div>
                            </div>
                            <button type="button" id="book-now-btn" class="btn-book-now">
                                Book Now
                            </button>
                        </div>
                        <div class="quote-error hidden" id="quote-error">
                            <p id="quote-error-message"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkout Form (Hidden by default) -->
            <div class="checkout-container hidden" id="checkout-container">
                <!-- Your Stay Info Panel -->
                <div class="stay-info-panel" id="stay-info-panel">
                    <h3>Your New Orleans Stay</h3>

                    <!-- Weather -->
                    <div class="stay-section">
                        <div class="stay-section-header">
                            <span class="stay-icon">‚òÄÔ∏è</span>
                            <h4>Weather</h4>
                        </div>
                        <p class="stay-weather" id="stay-weather">Expect mild temperatures around 65¬∞F with occasional rain.</p>
                    </div>

                    <!-- Events During Stay -->
                    <div class="stay-section">
                        <div class="stay-section-header">
                            <span class="stay-icon">üé≠</span>
                            <h4>Events During Your Stay</h4>
                        </div>
                        <div class="stay-events" id="stay-events">
                            <p class="no-events-msg">No major events during these dates</p>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div class="stay-section">
                        <div class="stay-section-header">
                            <span class="stay-icon">‚ú®</span>
                            <h4>Don't Miss</h4>
                        </div>
                        <div class="stay-recommendations" id="stay-recommendations">
                            <div class="recommendation-item">
                                <strong>Bacchanal Wine</strong>
                                <span>Live jazz in the backyard, 10 min away</span>
                            </div>
                            <div class="recommendation-item">
                                <strong>Commander's Palace</strong>
                                <span>Iconic NOLA fine dining, 5 min away</span>
                            </div>
                            <div class="recommendation-item">
                                <strong>Magazine Street</strong>
                                <span>Shopping & restaurants, 2 min walk</span>
                            </div>
                        </div>
                    </div>

                    <!-- Add-ons Preview -->
                    <div class="stay-section">
                        <div class="stay-section-header">
                            <span class="stay-icon">üéÅ</span>
                            <h4>Enhance Your Stay</h4>
                        </div>
                        <p class="stay-addons-hint">Add services like cold plunge, private chef, or early check-in during checkout.</p>
                    </div>
                </div>

                <div class="checkout-card">
                    <h3>Complete Your Reservation</h3>
                    <div class="checkout-summary" id="checkout-summary"></div>

                    <form id="checkout-form">
                        <div class="form-row">
                            <div class="form-field">
                                <label for="guest-first-name">First Name</label>
                                <input type="text" id="guest-first-name" required>
                            </div>
                            <div class="form-field">
                                <label for="guest-last-name">Last Name</label>
                                <input type="text" id="guest-last-name" required>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="guest-email">Email</label>
                            <input type="email" id="guest-email" required>
                        </div>
                        <div class="form-field">
                            <label for="guest-phone">Phone</label>
                            <input type="tel" id="guest-phone">
                        </div>

                        <!-- Add-on Services -->
                        <div class="addons-section">
                            <label class="addons-label">Enhance Your Stay</label>
                            <div class="addon-options">
                                <label class="addon-item">
                                    <input type="checkbox" id="addon-coldplunge" data-price="150" data-name="Cold Plunge">
                                    <div class="addon-info">
                                        <span class="addon-name">Cold Plunge</span>
                                        <span class="addon-desc">Portable ice bath delivered to the property</span>
                                    </div>
                                    <span class="addon-price">+$150</span>
                                </label>
                                <label class="addon-item">
                                    <input type="checkbox" id="addon-chef" data-price="350" data-name="Private Chef">
                                    <div class="addon-info">
                                        <span class="addon-name">Private Chef</span>
                                        <span class="addon-desc">One dinner for up to 10 guests</span>
                                    </div>
                                    <span class="addon-price">+$350</span>
                                </label>
                                <label class="addon-item">
                                    <input type="checkbox" id="addon-massage" data-price="200" data-name="In-Home Massage">
                                    <div class="addon-info">
                                        <span class="addon-name">In-Home Massage</span>
                                        <span class="addon-desc">Licensed massage therapist (60 min)</span>
                                    </div>
                                    <span class="addon-price">+$200</span>
                                </label>
                                <label class="addon-item">
                                    <input type="checkbox" id="addon-earlycheck" data-price="100" data-name="Early Check-in">
                                    <div class="addon-info">
                                        <span class="addon-name">Early Check-in</span>
                                        <span class="addon-desc">Check in at 12pm instead of 4pm</span>
                                    </div>
                                    <span class="addon-price">+$100</span>
                                </label>
                            </div>
                            <div class="addons-total hidden" id="addons-total">
                                <span>Add-ons:</span>
                                <span id="addons-total-amount">$0</span>
                            </div>
                        </div>

                        <div class="form-field">
                            <label>Card Details</label>
                            <div id="card-element"></div>
                            <div id="card-errors" class="card-errors"></div>
                        </div>

                        <label class="checkbox-label">
                            <input type="checkbox" id="accept-terms" required>
                            <span>I agree to the <a href="#" target="_blank">terms</a> and <a href="#" target="_blank">cancellation policy</a></span>
                        </label>

                        <button type="submit" id="submit-booking" class="btn-submit-booking">
                            Confirm Reservation
                        </button>
                    </form>
                </div>
            </div>

            <!-- Booking Confirmation (Hidden by default) -->
            <div class="booking-confirmation hidden" id="booking-confirmation">
                <div class="confirmation-icon">‚úì</div>
                <h3>You're all set</h3>
                <p>Confirmation details have been sent to your email.</p>
                <div class="confirmation-details" id="confirmation-details"></div>
            </div>
        </div>
    </section>

    <!-- Scene 3: The Art - Egret Reveal -->
    <section class="scene scene-art" id="art">
        <div class="art-container">
            <div class="art-frame">
                <img src="Copy of 1.jpg" alt="Louisiana Egret" class="art-image">
            </div>
            <div class="art-text">
                <span class="scene-label">The Art</span>
                <h2>Every wall tells a story</h2>
                <p>Original Louisiana artwork adorns this home‚Äîfrom the hand-painted egret watching over the living room to murals of moss-draped oaks. This isn't a rental. It's a gallery you can sleep in.</p>
            </div>
        </div>
    </section>

    <!-- Scene 4: The Space - Living Areas -->
    <section class="scene scene-space" id="space">
        <div class="space-gallery">
            <div class="space-image space-image-main">
                <img src="Copy of 3.jpg" alt="Living Space" loading="lazy">
            </div>
            <div class="space-image space-image-secondary">
                <img src="Copy of 6.jpg" alt="Interior Detail" loading="lazy">
            </div>
        </div>
        <div class="space-content">
            <span class="scene-label">The Space</span>
            <h2>Five bedrooms.<br>Endless light.</h2>
            <p>Soaring ceilings, walls of glass, and a layout designed for gathering. Modern architecture meets Southern warmth‚Äîevery corner invites you to stay a while.</p>
        </div>
    </section>

    <!-- Scene 5: The Water - Pool Paradise -->
    <section class="scene scene-water" id="water">
        <div class="water-bg">
            <img src="Copy of 50.jpg" alt="Pool" loading="lazy">
        </div>
        <div class="water-overlay"></div>
        <div class="water-content">
            <span class="scene-label">The Water</span>
            <h2>Your private paradise</h2>
            <p>A heated pool for every season. A tiki bar for every mood. Tropical gardens, outdoor speakers, and evenings that stretch into New Orleans nights.</p>
        </div>
    </section>

    <!-- Scene 6: The Layout - Floor Plan -->
    <section class="scene scene-layout" id="layout">
        <div class="layout-container">
            <div class="layout-text">
                <span class="scene-label">The Layout</span>
                <h2>Room to roam</h2>
                <p>Two floors of thoughtfully designed space. Five bedrooms with king and queen beds, open living areas, and seamless flow between indoors and out.</p>
            </div>
            <div class="layout-image">
                <img src="2300 floor sketch.jpg" alt="Floor Plan" loading="lazy">
            </div>
        </div>
    </section>

    <!-- Scene 7: The Details - Horizontal Scroll -->
    <section class="scene scene-details" id="details">
        <div class="details-header">
            <span class="scene-label">The Details</span>
            <h2>Everything you need, nothing you don't</h2>
        </div>
        <div class="details-scroll-container">
            <div class="details-track">
                <div class="detail-card">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                        </svg>
                    </div>
                    <h3>5 Bedrooms</h3>
                    <p>King beds, luxury linens, room to breathe</p>
                </div>
                <div class="detail-card">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
                        </svg>
                    </div>
                    <h3>Heated Pool</h3>
                    <p>Year-round swimming under Louisiana skies</p>
                </div>
                <div class="detail-card">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                        </svg>
                    </div>
                    <h3>Indoor/Outdoor Sound</h3>
                    <p>Speakers throughout for your soundtrack</p>
                </div>
                <div class="detail-card">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <h3>Sleeps 10</h3>
                    <p>Gather the whole crew</p>
                </div>
                <div class="detail-card">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"/>
                            <circle cx="12" cy="12" r="4"/>
                        </svg>
                    </div>
                    <h3>Tiki Bar</h3>
                    <p>Mix drinks, make memories</p>
                </div>
                <div class="detail-card">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="2" y="7" width="20" height="14" rx="2"/>
                            <path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/>
                        </svg>
                    </div>
                    <h3>Work-Ready</h3>
                    <p>Fast WiFi, dedicated workspace</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Scene 8: The Neighborhood -->
    <section class="scene scene-neighborhood" id="neighborhood">
        <div class="neighborhood-grid">
            <div class="neighborhood-image">
                <img src="nola-magazine.jpg" alt="Magazine Street" loading="lazy">
            </div>
            <div class="neighborhood-content">
                <span class="scene-label">The Neighborhood</span>
                <h2>Steps from Magazine Street</h2>
                <p>You're in the Irish Channel‚Äîone of New Orleans' most vibrant neighborhoods. Walk to world-class restaurants, dive bars, antique shops, and live music. The French Quarter is a short streetcar ride away.</p>
                <div class="neighborhood-highlights">
                    <div class="highlight">
                        <span class="highlight-distance">2 min walk</span>
                        <span class="highlight-name">Magazine Street</span>
                    </div>
                    <div class="highlight">
                        <span class="highlight-distance">10 min</span>
                        <span class="highlight-name">Garden District</span>
                    </div>
                    <div class="highlight">
                        <span class="highlight-distance">15 min</span>
                        <span class="highlight-name">French Quarter</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Scene 9: The Gallery - More Images -->
    <section class="scene scene-gallery" id="gallery">
        <div class="gallery-header">
            <span class="scene-label">The Gallery</span>
            <h2>See more</h2>
        </div>
        <div class="gallery-mosaic">
            <div class="mosaic-item mosaic-large">
                <img src="Copy of 45.jpg" alt="Pool deck" loading="lazy">
            </div>
            <div class="mosaic-item">
                <img src="Copy of 10.jpg" alt="Bedroom" loading="lazy">
            </div>
            <div class="mosaic-item">
                <img src="Copy of 17.jpg" alt="Kitchen" loading="lazy">
            </div>
            <div class="mosaic-item mosaic-tall">
                <img src="Copy of 21.jpg" alt="Bathroom" loading="lazy">
            </div>
            <div class="mosaic-item">
                <img src="Copy of 35.jpg" alt="Outdoor" loading="lazy">
            </div>
            <div class="mosaic-item mosaic-wide">
                <img src="Copy of 40.jpg" alt="Evening" loading="lazy">
            </div>
            <div class="mosaic-item">
                <img src="Copy of 28.jpg" alt="Detail" loading="lazy">
            </div>
            <div class="mosaic-item">
                <img src="Copy of 32.jpg" alt="Living" loading="lazy">
            </div>
        </div>
    </section>

    <!-- Scene 10: Guest Reviews -->
    <section class="scene scene-reviews" id="reviews">
        <div class="reviews-container">
            <div class="reviews-header">
                <span class="scene-label">Guest Stories</span>
                <h2>What people are saying</h2>
            </div>
            <div class="reviews-grid">
                <div class="review-card">
                    <div class="review-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                    <p class="review-text">"Absolutely stunning home. The artwork throughout made it feel like staying in a gallery. The pool was perfect and Magazine Street is right there. We didn't want to leave."</p>
                    <div class="review-author">
                        <span class="review-name">Sarah M.</span>
                        <span class="review-date">October 2024</span>
                    </div>
                </div>
                <div class="review-card">
                    <div class="review-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                    <p class="review-text">"Best Airbnb we've ever stayed in. The space is incredible - those high ceilings and the indoor/outdoor flow. Had 8 people and everyone had room to spread out. The tiki bar was a hit!"</p>
                    <div class="review-author">
                        <span class="review-name">James & Co.</span>
                        <span class="review-date">September 2024</span>
                    </div>
                </div>
                <div class="review-card">
                    <div class="review-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                    <p class="review-text">"We came for Jazz Fest and this was the perfect home base. The neighborhood is wonderful - walkable to so much. The heated pool after long festival days was everything."</p>
                    <div class="review-author">
                        <span class="review-name">The Wilsons</span>
                        <span class="review-date">May 2024</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-brand">
                <span class="footer-logo">Marais</span>
                <p>A New Orleans Art House</p>
            </div>
            <div class="footer-links">
                <a href="#art">The Art</a>
                <a href="#space">The Space</a>
                <a href="#water">The Water</a>
                <a href="#neighborhood">Neighborhood</a>
                <a href="#book">Book</a>
            </div>
            <div class="footer-contact">
                <p>New Orleans, Louisiana</p>
                <p>Irish Channel</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Marais. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // ============================================
        // LOADING SCREEN
        // ============================================
        // Loading screen with 2 second branding moment
        const loader = document.getElementById('loader');
        const hideLoader = () => {
            loader.classList.add('loaded');
            document.body.classList.add('page-loaded');
        };

        setTimeout(hideLoader, 2000);

        // ============================================
        // LIGHTBOX
        // ============================================
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxClose = document.getElementById('lightbox-close');
        const lightboxPrev = document.getElementById('lightbox-prev');
        const lightboxNext = document.getElementById('lightbox-next');
        let currentImageIndex = 0;
        let galleryImages = [];

        // Collect all gallery images
        document.querySelectorAll('.gallery-mosaic .mosaic-item img, .space-image img').forEach((img, index) => {
            galleryImages.push(img.src);
            img.style.cursor = 'pointer';
            img.addEventListener('click', () => {
                currentImageIndex = index;
                openLightbox(img.src);
            });
        });

        function openLightbox(src) {
            lightboxImg.src = src;
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            lightbox.classList.remove('active');
            document.body.style.overflow = '';
        }

        function showPrevImage() {
            currentImageIndex = (currentImageIndex - 1 + galleryImages.length) % galleryImages.length;
            lightboxImg.src = galleryImages[currentImageIndex];
        }

        function showNextImage() {
            currentImageIndex = (currentImageIndex + 1) % galleryImages.length;
            lightboxImg.src = galleryImages[currentImageIndex];
        }

        lightboxClose.addEventListener('click', closeLightbox);
        lightboxPrev.addEventListener('click', showPrevImage);
        lightboxNext.addEventListener('click', showNextImage);
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) closeLightbox();
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('active')) return;
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') showPrevImage();
            if (e.key === 'ArrowRight') showNextImage();
        });

        // ============================================
        // NAVIGATION
        // ============================================
        const nav = document.getElementById('nav');
        let lastScroll = 0;

        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset;

            // Show nav after scrolling past first scene
            if (currentScroll > window.innerHeight * 0.5) {
                nav.classList.add('visible');
            } else {
                nav.classList.remove('visible');
            }

            lastScroll = currentScroll;
        });

        // ============================================
        // SCROLL ANIMATIONS
        // ============================================
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -10% 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('in-view');
                }
            });
        }, observerOptions);

        // Observe all scenes and animated elements
        document.querySelectorAll('.scene, .animate-in').forEach(el => {
            observer.observe(el);
        });

        // ============================================
        // SMOOTH SCROLL FOR ANCHOR LINKS
        // ============================================
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // ============================================
        // HORIZONTAL SCROLL FOR DETAILS
        // ============================================
        const detailsSection = document.querySelector('.scene-details');
        const detailsTrack = document.querySelector('.details-track');

        if (detailsSection && detailsTrack) {
            // Add horizontal scroll on wheel in details section
            detailsSection.addEventListener('wheel', (e) => {
                if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
                    const container = document.querySelector('.details-scroll-container');
                    container.scrollLeft += e.deltaY;
                }
            }, { passive: true });
        }

        // ============================================
        // NEW ORLEANS EVENTS & FESTIVALS
        // ============================================
        const nolaEvents = [
            // =============================================
            // 2025 EVENTS
            // =============================================

            // JANUARY 2025
            { start: '2025-01-06', end: '2025-01-06', name: 'King Cake Season Begins', type: 'event' },
            { start: '2025-01-11', end: '2025-01-11', name: 'Phunny Phorty Phellows', type: 'parade', desc: 'Streetcar parade kicks off Carnival' },
            { start: '2025-01-18', end: '2025-01-18', name: 'Krewe of Joan of Arc', type: 'parade', desc: 'French Quarter walking parade' },
            { start: '2025-01-20', end: '2025-01-20', name: 'MLK Day Parade', type: 'parade' },

            // FEBRUARY 2025 - MARDI GRAS SEASON
            { start: '2025-02-08', end: '2025-02-08', name: 'Krewe of Oshun', type: 'parade' },
            { start: '2025-02-08', end: '2025-02-08', name: 'Krewe of Cleopatra', type: 'parade' },
            { start: '2025-02-14', end: '2025-02-14', name: 'Krewe of Eve', type: 'parade' },
            { start: '2025-02-14', end: '2025-02-14', name: "Valentine's Day", type: 'event' },
            { start: '2025-02-15', end: '2025-02-15', name: 'Krewe of Pontchartrain', type: 'parade' },
            { start: '2025-02-21', end: '2025-02-21', name: 'Krewe of Nyx', type: 'parade', desc: 'Largest all-female krewe' },
            { start: '2025-02-22', end: '2025-02-22', name: 'Krewe of Endymion', type: 'parade', desc: 'Mega parade - Mid City' },
            { start: '2025-02-23', end: '2025-02-23', name: 'Krewe of Bacchus', type: 'parade', desc: 'Celebrity king parade' },
            { start: '2025-02-24', end: '2025-02-24', name: 'Krewe of Orpheus', type: 'parade', desc: 'Lundi Gras super krewe' },
            { start: '2025-02-25', end: '2025-02-25', name: 'Zulu Parade', type: 'parade', desc: 'Mardi Gras morning - coconuts!' },
            { start: '2025-02-25', end: '2025-02-25', name: 'Rex Parade', type: 'parade', desc: 'King of Carnival' },
            { start: '2025-02-25', end: '2025-02-25', name: 'Mardi Gras Day', type: 'festival', desc: 'Fat Tuesday!' },
            { start: '2025-02-28', end: '2025-03-02', name: 'Buku Music + Art Project', type: 'festival', desc: 'Electronic music festival' },

            // MARCH 2025
            { start: '2025-03-02', end: '2025-03-02', name: 'Lundi Gras Second Line', type: 'secondline' },
            { start: '2025-03-09', end: '2025-03-09', name: "Super Sunday - St. Joseph's", type: 'secondline', desc: 'Mardi Gras Indians' },
            { start: '2025-03-15', end: '2025-03-16', name: 'Irish Channel Parade', type: 'parade', desc: 'Block party on Magazine St' },
            { start: '2025-03-17', end: '2025-03-17', name: "St. Patrick's Day", type: 'event' },
            { start: '2025-03-19', end: '2025-03-19', name: "St. Joseph's Day", type: 'event', desc: 'Italian altars throughout city' },
            { start: '2025-03-21', end: '2025-03-23', name: 'NOLA Pyrate Week', type: 'event' },
            { start: '2025-03-23', end: '2025-03-23', name: 'Second Line (Treme)', type: 'secondline' },
            { start: '2025-03-28', end: '2025-03-30', name: 'Tennessee Williams Festival', type: 'festival' },
            { start: '2025-03-29', end: '2025-03-29', name: 'Chris Owens Easter Parade', type: 'parade' },

            // APRIL 2025
            { start: '2025-04-04', end: '2025-04-06', name: 'Hogs for the Cause', type: 'festival', desc: 'BBQ & music' },
            { start: '2025-04-10', end: '2025-04-13', name: 'French Quarter Festival', type: 'festival', desc: 'Free music throughout FQ' },
            { start: '2025-04-13', end: '2025-04-13', name: 'Second Line (7th Ward)', type: 'secondline' },
            { start: '2025-04-20', end: '2025-04-20', name: 'Second Line (Uptown)', type: 'secondline' },
            { start: '2025-04-25', end: '2025-04-27', name: 'Jazz Fest Weekend 1', type: 'festival', desc: 'New Orleans Jazz & Heritage Festival' },
            { start: '2025-04-27', end: '2025-04-27', name: 'Second Line (Treme)', type: 'secondline' },

            // MAY 2025
            { start: '2025-05-01', end: '2025-05-04', name: 'Jazz Fest Weekend 2', type: 'festival', desc: 'New Orleans Jazz & Heritage Festival' },
            { start: '2025-05-04', end: '2025-05-04', name: 'Second Line (Central City)', type: 'secondline' },
            { start: '2025-05-09', end: '2025-05-11', name: 'Bayou Boogaloo', type: 'festival', desc: 'Free fest on Bayou St. John' },
            { start: '2025-05-11', end: '2025-05-11', name: 'Second Line (7th Ward)', type: 'secondline' },
            { start: '2025-05-16', end: '2025-05-18', name: 'New Orleans Wine & Food', type: 'festival' },
            { start: '2025-05-18', end: '2025-05-18', name: 'Second Line (Uptown)', type: 'secondline' },
            { start: '2025-05-23', end: '2025-05-25', name: 'Greek Festival', type: 'festival' },

            // JUNE 2025
            { start: '2025-06-01', end: '2025-06-01', name: 'Second Line (Treme)', type: 'secondline' },
            { start: '2025-06-06', end: '2025-06-08', name: 'Creole Tomato Festival', type: 'festival', desc: 'French Market' },
            { start: '2025-06-07', end: '2025-06-07', name: 'Pride Parade', type: 'parade' },
            { start: '2025-06-15', end: '2025-06-15', name: 'Second Line (7th Ward)', type: 'secondline' },
            { start: '2025-06-20', end: '2025-06-22', name: 'Oyster Festival', type: 'festival' },
            { start: '2025-06-22', end: '2025-06-22', name: 'Second Line (Central City)', type: 'secondline' },

            // JULY 2025
            { start: '2025-07-03', end: '2025-07-06', name: 'Essence Festival', type: 'festival', desc: 'Biggest party in NOLA' },
            { start: '2025-07-04', end: '2025-07-04', name: 'Go 4th on the River', type: 'event', desc: 'Fireworks on the Mississippi' },
            { start: '2025-07-13', end: '2025-07-13', name: 'Second Line (Uptown)', type: 'secondline' },
            { start: '2025-07-18', end: '2025-07-20', name: 'Tales of the Cocktail', type: 'festival', desc: 'World cocktail conference' },
            { start: '2025-07-20', end: '2025-07-20', name: 'Second Line (Treme)', type: 'secondline' },
            { start: '2025-07-27', end: '2025-07-27', name: 'Second Line (7th Ward)', type: 'secondline' },

            // AUGUST 2025
            { start: '2025-08-01', end: '2025-08-03', name: 'Satchmo SummerFest', type: 'festival', desc: 'Louis Armstrong celebration' },
            { start: '2025-08-02', end: '2025-08-02', name: 'White Linen Night', type: 'event', desc: 'Art walk on Julia St' },
            { start: '2025-08-09', end: '2025-08-09', name: 'Dirty Linen Night', type: 'event', desc: 'Art walk on Royal St' },
            { start: '2025-08-09', end: '2025-08-09', name: 'Red Dress Run', type: 'event', desc: 'Hash House Harriers charity run' },
            { start: '2025-08-10', end: '2025-08-10', name: 'Second Line (Central City)', type: 'secondline' },
            { start: '2025-08-17', end: '2025-08-17', name: 'Second Line (Uptown)', type: 'secondline' },
            { start: '2025-08-22', end: '2025-08-24', name: 'COOLinary Restaurant Weeks', type: 'event', desc: 'Prix fixe dining deals' },
            { start: '2025-08-24', end: '2025-08-24', name: 'Second Line (Treme)', type: 'secondline' },

            // SEPTEMBER 2025
            { start: '2025-09-05', end: '2025-09-07', name: 'Southern Decadence', type: 'festival', desc: 'LGBTQ+ celebration in FQ' },
            { start: '2025-09-07', end: '2025-09-07', name: 'Second Line (7th Ward)', type: 'secondline' },
            { start: '2025-09-14', end: '2025-09-14', name: 'Second Line (Uptown)', type: 'secondline' },
            { start: '2025-09-19', end: '2025-09-21', name: 'Fried Chicken Festival', type: 'festival', desc: 'Free admission!' },
            { start: '2025-09-21', end: '2025-09-21', name: 'Second Line (Central City)', type: 'secondline' },
            { start: '2025-09-28', end: '2025-09-28', name: 'Second Line (Treme)', type: 'secondline' },

            // OCTOBER 2025
            { start: '2025-10-03', end: '2025-10-05', name: 'Crescent City Blues Fest', type: 'festival' },
            { start: '2025-10-05', end: '2025-10-05', name: 'Second Line (7th Ward)', type: 'secondline' },
            { start: '2025-10-10', end: '2025-10-12', name: 'Beignet Festival', type: 'festival' },
            { start: '2025-10-12', end: '2025-10-12', name: 'Second Line (Uptown)', type: 'secondline' },
            { start: '2025-10-17', end: '2025-10-19', name: 'Boudin Bourbon & Beer', type: 'festival' },
            { start: '2025-10-19', end: '2025-10-19', name: 'Second Line (Central City)', type: 'secondline' },
            { start: '2025-10-25', end: '2025-10-27', name: 'Voodoo Music Festival', type: 'festival', desc: 'City Park mega concert' },
            { start: '2025-10-26', end: '2025-10-26', name: 'Krewe of Boo', type: 'parade', desc: 'Halloween parade downtown' },
            { start: '2025-10-31', end: '2025-10-31', name: 'Halloween in the Quarter', type: 'event', desc: 'Costumes on Frenchmen & Bourbon' },

            // NOVEMBER 2025
            { start: '2025-11-02', end: '2025-11-02', name: 'Second Line (Treme)', type: 'secondline' },
            { start: '2025-11-09', end: '2025-11-09', name: 'Second Line (7th Ward)', type: 'secondline' },
            { start: '2025-11-14', end: '2025-11-16', name: 'Oak Street Po-Boy Festival', type: 'festival' },
            { start: '2025-11-16', end: '2025-11-16', name: 'Second Line (Uptown)', type: 'secondline' },
            { start: '2025-11-23', end: '2025-11-23', name: 'Second Line (Central City)', type: 'secondline' },
            { start: '2025-11-27', end: '2025-11-27', name: 'Thanksgiving', type: 'event' },
            { start: '2025-11-28', end: '2025-11-29', name: 'Bayou Classic', type: 'event', desc: 'Grambling vs Southern football' },
            { start: '2025-11-29', end: '2025-11-29', name: 'Celebration in the Oaks', type: 'event', desc: 'Holiday lights - City Park' },

            // DECEMBER 2025
            { start: '2025-12-06', end: '2025-12-06', name: 'Krewe of Jingle', type: 'parade', desc: 'Holiday bike parade' },
            { start: '2025-12-07', end: '2025-12-07', name: 'Second Line (Treme)', type: 'secondline' },
            { start: '2025-12-13', end: '2025-12-14', name: 'LUNA Fete', type: 'event', desc: 'Light art projections downtown' },
            { start: '2025-12-14', end: '2025-12-14', name: 'Second Line (7th Ward)', type: 'secondline' },
            { start: '2025-12-20', end: '2025-12-20', name: 'Caroling in Jackson Square', type: 'event' },
            { start: '2025-12-21', end: '2025-12-21', name: 'Second Line (Uptown)', type: 'secondline' },
            { start: '2025-12-24', end: '2025-12-24', name: 'Christmas Eve Bonfires', type: 'event', desc: 'On the levee in St. James Parish' },
            { start: '2025-12-25', end: '2025-12-25', name: 'Christmas Day', type: 'event' },
            { start: '2025-12-31', end: '2025-12-31', name: 'New Years Eve', type: 'event', desc: 'Fleur de lis drop at Jax Brewery' },

            // =============================================
            // 2026 EVENTS
            // =============================================

            // JANUARY 2026
            { start: '2026-01-01', end: '2026-01-01', name: 'Allstate Sugar Bowl', type: 'event' },
            { start: '2026-01-06', end: '2026-01-06', name: 'King Cake Season Begins', type: 'event' },
            { start: '2026-01-10', end: '2026-01-10', name: 'Phunny Phorty Phellows', type: 'parade' },
            { start: '2026-01-17', end: '2026-01-17', name: 'Krewe of Joan of Arc', type: 'parade' },
            { start: '2026-01-19', end: '2026-01-19', name: 'MLK Day Parade', type: 'parade' },
            { start: '2026-01-25', end: '2026-01-25', name: 'Second Line (Treme)', type: 'secondline' },

            // FEBRUARY 2026 - MARDI GRAS
            { start: '2026-02-01', end: '2026-02-01', name: 'Second Line (7th Ward)', type: 'secondline' },
            { start: '2026-02-06', end: '2026-02-06', name: 'Krewe of Oshun', type: 'parade' },
            { start: '2026-02-07', end: '2026-02-07', name: 'Krewe of Cleopatra', type: 'parade' },
            { start: '2026-02-08', end: '2026-02-08', name: 'Second Line (Uptown)', type: 'secondline' },
            { start: '2026-02-13', end: '2026-02-13', name: 'Krewe of Nyx', type: 'parade' },
            { start: '2026-02-14', end: '2026-02-14', name: 'Krewe of Endymion', type: 'parade', desc: 'Mega parade + Extravaganza' },
            { start: '2026-02-14', end: '2026-02-14', name: "Valentine's Day", type: 'event' },
            { start: '2026-02-15', end: '2026-02-15', name: 'Krewe of Bacchus', type: 'parade' },
            { start: '2026-02-16', end: '2026-02-16', name: 'Krewe of Orpheus', type: 'parade', desc: 'Lundi Gras' },
            { start: '2026-02-17', end: '2026-02-17', name: 'Zulu Parade', type: 'parade', desc: 'Get a coconut!' },
            { start: '2026-02-17', end: '2026-02-17', name: 'Rex Parade', type: 'parade' },
            { start: '2026-02-17', end: '2026-02-17', name: 'Mardi Gras Day', type: 'festival', desc: 'Fat Tuesday!' },
            { start: '2026-02-27', end: '2026-03-01', name: 'Buku Music + Art Project', type: 'festival' },

            // MARCH 2026
            { start: '2026-03-01', end: '2026-03-01', name: 'Super Sunday', type: 'secondline', desc: 'Mardi Gras Indians' },
            { start: '2026-03-14', end: '2026-03-15', name: 'Irish Channel Parade', type: 'parade' },
            { start: '2026-03-17', end: '2026-03-17', name: "St. Patrick's Day", type: 'event' },
            { start: '2026-03-19', end: '2026-03-19', name: "St. Joseph's Day", type: 'event' },
            { start: '2026-03-27', end: '2026-03-29', name: 'Tennessee Williams Festival', type: 'festival' },

            // APRIL 2026
            { start: '2026-04-03', end: '2026-04-05', name: 'Hogs for the Cause', type: 'festival' },
            { start: '2026-04-09', end: '2026-04-12', name: 'French Quarter Festival', type: 'festival', desc: 'Free music throughout FQ' },
            { start: '2026-04-24', end: '2026-04-26', name: 'Jazz Fest Weekend 1', type: 'festival' },

            // MAY 2026
            { start: '2026-05-01', end: '2026-05-03', name: 'Jazz Fest Weekend 2', type: 'festival' },
            { start: '2026-05-08', end: '2026-05-10', name: 'Bayou Boogaloo', type: 'festival' },
            { start: '2026-05-15', end: '2026-05-17', name: 'New Orleans Wine & Food', type: 'festival' },
            { start: '2026-05-22', end: '2026-05-24', name: 'Greek Festival', type: 'festival' },

            // JUNE 2026
            { start: '2026-06-05', end: '2026-06-07', name: 'Creole Tomato Festival', type: 'festival' },
            { start: '2026-06-13', end: '2026-06-13', name: 'Pride Parade', type: 'parade' },
            { start: '2026-06-19', end: '2026-06-21', name: 'Oyster Festival', type: 'festival' },

            // JULY 2026
            { start: '2026-07-02', end: '2026-07-05', name: 'Essence Festival', type: 'festival' },
            { start: '2026-07-04', end: '2026-07-04', name: 'Go 4th on the River', type: 'event' },
            { start: '2026-07-17', end: '2026-07-19', name: 'Tales of the Cocktail', type: 'festival' },

            // AUGUST 2026
            { start: '2026-08-07', end: '2026-08-09', name: 'Satchmo SummerFest', type: 'festival' },
            { start: '2026-08-01', end: '2026-08-01', name: 'White Linen Night', type: 'event' },
            { start: '2026-08-08', end: '2026-08-08', name: 'Dirty Linen Night', type: 'event' },
            { start: '2026-08-08', end: '2026-08-08', name: 'Red Dress Run', type: 'event' },

            // SEPTEMBER 2026
            { start: '2026-09-04', end: '2026-09-06', name: 'Southern Decadence', type: 'festival' },
            { start: '2026-09-18', end: '2026-09-20', name: 'Fried Chicken Festival', type: 'festival' },

            // OCTOBER 2026
            { start: '2026-10-02', end: '2026-10-04', name: 'Crescent City Blues Fest', type: 'festival' },
            { start: '2026-10-09', end: '2026-10-11', name: 'Beignet Festival', type: 'festival' },
            { start: '2026-10-16', end: '2026-10-18', name: 'Boudin Bourbon & Beer', type: 'festival' },
            { start: '2026-10-30', end: '2026-11-01', name: 'Voodoo Music Festival', type: 'festival' },
            { start: '2026-10-25', end: '2026-10-25', name: 'Krewe of Boo', type: 'parade' },
            { start: '2026-10-31', end: '2026-10-31', name: 'Halloween', type: 'event' },

            // NOVEMBER 2026
            { start: '2026-11-13', end: '2026-11-15', name: 'Oak Street Po-Boy Festival', type: 'festival' },
            { start: '2026-11-26', end: '2026-11-26', name: 'Thanksgiving', type: 'event' },
            { start: '2026-11-27', end: '2026-11-28', name: 'Bayou Classic', type: 'event' },
            { start: '2026-11-28', end: '2026-11-28', name: 'Celebration in the Oaks', type: 'event' },

            // DECEMBER 2026
            { start: '2026-12-05', end: '2026-12-05', name: 'Krewe of Jingle', type: 'parade' },
            { start: '2026-12-12', end: '2026-12-13', name: 'LUNA Fete', type: 'event' },
            { start: '2026-12-19', end: '2026-12-19', name: 'Caroling in Jackson Square', type: 'event' },
            { start: '2026-12-24', end: '2026-12-24', name: 'Christmas Eve Bonfires', type: 'event' },
            { start: '2026-12-25', end: '2026-12-25', name: 'Christmas Day', type: 'event' },
            { start: '2026-12-31', end: '2026-12-31', name: 'New Years Eve', type: 'event' },
        ];

        function getEventsForMonth(year, month) {
            return nolaEvents.filter(event => {
                const start = new Date(event.start);
                const end = new Date(event.end);
                return (start.getFullYear() === year && start.getMonth() === month) ||
                       (end.getFullYear() === year && end.getMonth() === month);
            });
        }

        function getEventsForDate(dateStr) {
            return nolaEvents.filter(event => dateStr >= event.start && dateStr <= event.end);
        }

        function getEventsForRange(startDate, endDate) {
            return nolaEvents.filter(event => {
                return (event.start >= startDate && event.start <= endDate) ||
                       (event.end >= startDate && event.end <= endDate) ||
                       (event.start <= startDate && event.end >= endDate);
            });
        }

        // ============================================
        // CUSTOM CALENDAR - TWO MONTH VIEW
        // ============================================
        const calendarContainer = document.getElementById('calendar-container');
        const calendarBackdrop = document.getElementById('calendar-backdrop');
        const calendarDays1 = document.getElementById('calendar-days-1');
        const calendarDays2 = document.getElementById('calendar-days-2');
        const calendarTitle1 = document.getElementById('calendar-title-1');
        const calendarTitle2 = document.getElementById('calendar-title-2');
        const eventsList = document.getElementById('events-list');

        function openCalendar() {
            calendarContainer.classList.remove('hidden');
            calendarBackdrop.classList.remove('hidden');
        }

        function closeCalendar() {
            calendarContainer.classList.add('hidden');
            calendarBackdrop.classList.add('hidden');
        }

        // Close when clicking backdrop
        calendarBackdrop.addEventListener('click', closeCalendar);
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectingFor = 'check-in';
        let selectedCheckIn = null;
        let selectedCheckOut = null;
        let availabilityData = {}; // Store availability by date
        let availabilityLoaded = false;

        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];

        // Fetch availability from Guesty
        async function fetchAvailability() {
            if (availabilityLoaded) return;
            try {
                const response = await fetch('/.netlify/functions/get-availability');
                const data = await response.json();

                // Handle both array format and object format from API
                let days = [];
                if (Array.isArray(data)) {
                    days = data;
                } else if (data.days) {
                    days = data.days;
                } else if (typeof data === 'object') {
                    // Convert object with numeric keys to array
                    days = Object.values(data).filter(d => d && d.date);
                }

                if (days.length > 0) {
                    days.forEach(day => {
                        if (day && day.date) {
                            availabilityData[day.date] = {
                                available: day.status === 'available',
                                status: day.status,
                                minNights: day.minNights || 1,
                                price: day.price
                            };
                        }
                    });
                    availabilityLoaded = true;
                    console.log('Availability loaded:', Object.keys(availabilityData).length, 'days');
                    renderCalendar(); // Re-render with availability
                }
            } catch (error) {
                console.log('Could not fetch availability:', error);
            }
        }

        function isDateAvailable(dateStr) {
            if (!availabilityLoaded) return true; // Assume available if not loaded
            const day = availabilityData[dateStr];
            if (!day) return true; // No data means assume available
            return day.status === 'available';
        }

        function renderMonth(container, year, month) {
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            container.innerHTML = '';

            // Empty cells for days before the first
            for (let i = 0; i < firstDay; i++) {
                container.innerHTML += '<div class="calendar-day empty"></div>';
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const events = getEventsForDate(dateStr);
                const isPast = date < today;
                const isAvailable = isDateAvailable(dateStr);
                const isCheckIn = selectedCheckIn === dateStr;
                const isCheckOut = selectedCheckOut === dateStr;
                const isInRange = selectedCheckIn && selectedCheckOut &&
                                  dateStr > selectedCheckIn && dateStr < selectedCheckOut;

                let classes = 'calendar-day';
                if (isPast) classes += ' disabled';
                else if (!isAvailable) classes += ' unavailable';
                if (isCheckIn) classes += ' check-in';
                if (isCheckOut) classes += ' check-out';
                if (isInRange) classes += ' in-range';
                if (events.length > 0) {
                    classes += ' has-event';
                    // Add class for highest priority event type
                    if (events.some(e => e.type === 'festival')) classes += ' festival';
                    else if (events.some(e => e.type === 'parade')) classes += ' parade';
                    else if (events.some(e => e.type === 'secondline')) classes += ' secondline';
                    else classes += ' event';
                }

                let eventDots = '';
                if (events.length > 0) {
                    const uniqueTypes = [...new Set(events.map(e => e.type))];
                    eventDots = uniqueTypes.slice(0, 3).map(t => `<span class="event-dot ${t}"></span>`).join('');
                }

                const isClickable = !isPast && isAvailable;
                container.innerHTML += `
                    <div class="${classes}" data-date="${dateStr}" ${isClickable ? `onclick="selectDate('${dateStr}')"` : ''}>
                        <span class="day-number">${day}</span>
                        <div class="event-dots">${eventDots}</div>
                    </div>
                `;
            }
        }

        function renderCalendar() {
            // Render first month
            calendarTitle1.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            renderMonth(calendarDays1, currentYear, currentMonth);

            // Render second month
            let month2 = currentMonth + 1;
            let year2 = currentYear;
            if (month2 > 11) {
                month2 = 0;
                year2++;
            }
            calendarTitle2.textContent = `${monthNames[month2]} ${year2}`;
            renderMonth(calendarDays2, year2, month2);

            // Render events list
            updateEventsList();
        }

        function updateEventsList() {
            let events = [];

            if (selectedCheckIn && selectedCheckOut) {
                // Show events during selected stay
                events = getEventsForRange(selectedCheckIn, selectedCheckOut);
                document.querySelector('.events-subtitle').textContent = 'Events during your stay';
            } else {
                // Show events for both visible months
                const month1Events = getEventsForMonth(currentYear, currentMonth);
                let month2 = currentMonth + 1;
                let year2 = currentYear;
                if (month2 > 11) { month2 = 0; year2++; }
                const month2Events = getEventsForMonth(year2, month2);
                events = [...month1Events, ...month2Events];
                // Remove duplicates
                events = events.filter((e, i, arr) => arr.findIndex(x => x.name === e.name && x.start === e.start) === i);
                document.querySelector('.events-subtitle').textContent = 'Upcoming events in New Orleans';
            }

            // Sort by date
            events.sort((a, b) => a.start.localeCompare(b.start));

            if (events.length > 0) {
                eventsList.innerHTML = events.map(e => `
                    <div class="event-item ${e.type}">
                        <div class="event-dot-wrapper"><span class="event-dot ${e.type}"></span></div>
                        <div class="event-info">
                            <span class="event-name">${e.name}</span>
                            ${e.desc ? `<span class="event-desc">${e.desc}</span>` : ''}
                        </div>
                        <span class="event-dates">${formatEventDates(e.start, e.end)}</span>
                    </div>
                `).join('');
            } else {
                eventsList.innerHTML = '<div class="no-events">No major events during this period</div>';
            }
        }

        function formatEventDates(start, end) {
            const s = new Date(start + 'T00:00:00');
            const e = new Date(end + 'T00:00:00');
            const opts = { month: 'short', day: 'numeric' };
            if (start === end) {
                return s.toLocaleDateString('en-US', opts);
            }
            return `${s.toLocaleDateString('en-US', opts)} - ${e.toLocaleDateString('en-US', opts)}`;
        }

        function updateCalendarInstruction() {
            const instructionEl = document.querySelector('.instruction-text');
            const doneBtn = document.getElementById('calendar-done');

            if (!selectedCheckIn) {
                instructionEl.textContent = 'Select your arrival date';
                doneBtn.classList.add('hidden');
            } else if (!selectedCheckOut) {
                instructionEl.textContent = 'Now select your departure date';
                doneBtn.classList.add('hidden');
            } else {
                const nights = Math.round((new Date(selectedCheckOut) - new Date(selectedCheckIn)) / (1000 * 60 * 60 * 24));
                instructionEl.textContent = `${nights} night${nights > 1 ? 's' : ''} selected`;
                doneBtn.classList.remove('hidden');
            }
        }

        window.selectDate = function(dateStr) {
            if (selectingFor === 'check-in' || !selectedCheckIn) {
                selectedCheckIn = dateStr;
                selectedCheckOut = null;
                document.getElementById('check-in').value = dateStr;
                document.getElementById('check-in-display').textContent = formatDisplayDate(dateStr);
                document.getElementById('check-in-display').classList.add('has-value');
                document.getElementById('check-out-display').textContent = 'Select date';
                document.getElementById('check-out-display').classList.remove('has-value');
                document.getElementById('check-out').value = '';
                selectingFor = 'check-out';
            } else {
                if (dateStr <= selectedCheckIn) {
                    // Clicked before check-in, reset to new check-in
                    selectedCheckIn = dateStr;
                    selectedCheckOut = null;
                    document.getElementById('check-in').value = dateStr;
                    document.getElementById('check-in-display').textContent = formatDisplayDate(dateStr);
                    document.getElementById('check-out-display').textContent = 'Select date';
                    document.getElementById('check-out-display').classList.remove('has-value');
                    document.getElementById('check-out').value = '';
                    selectingFor = 'check-out';
                } else {
                    selectedCheckOut = dateStr;
                    document.getElementById('check-out').value = dateStr;
                    document.getElementById('check-out-display').textContent = formatDisplayDate(dateStr);
                    document.getElementById('check-out-display').classList.add('has-value');
                }
            }
            updateCalendarInstruction();
            renderCalendar();
        };

        // Done button closes calendar
        document.getElementById('calendar-done').addEventListener('click', closeCalendar);

        function formatDisplayDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Calendar navigation
        document.getElementById('cal-prev').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        });

        document.getElementById('cal-next').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        });

        // Open calendar when clicking date inputs
        document.querySelectorAll('.date-input').forEach(input => {
            input.addEventListener('click', (e) => {
                e.stopPropagation();
                selectingFor = input.dataset.target || 'check-in';
                openCalendar();
                fetchAvailability(); // Load availability data
                updateCalendarInstruction();
                renderCalendar();
            });
        });

        // Close calendar when pressing Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !calendarContainer.classList.contains('hidden')) {
                closeCalendar();
            }
        });

        // Add close button to calendar
        function addCloseButton() {
            if (!document.getElementById('calendar-close')) {
                const closeBtn = document.createElement('button');
                closeBtn.id = 'calendar-close';
                closeBtn.className = 'calendar-close-btn';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = closeCalendar;
                calendarContainer.querySelector('.calendar-main').prepend(closeBtn);
            }
        }
        addCloseButton();

        // Initialize calendar and prefetch availability
        renderCalendar();
        fetchAvailability();

        // ============================================
        // BOOKING FUNCTIONALITY
        // ============================================
        const checkInInput = document.getElementById('check-in');
        const checkOutInput = document.getElementById('check-out');
        const guestsSelect = document.getElementById('guests');
        const checkPricesBtn = document.getElementById('check-prices-btn');
        const quoteDisplay = document.getElementById('quote-display');
        const quoteLoading = document.getElementById('quote-loading');
        const quoteResult = document.getElementById('quote-result');
        const quoteError = document.getElementById('quote-error');
        const bookNowBtn = document.getElementById('book-now-btn');
        const checkoutContainer = document.getElementById('checkout-container');

        // Store quote data
        let currentQuote = null;

        // Check prices
        checkPricesBtn.addEventListener('click', async () => {
            const checkIn = checkInInput.value;
            const checkOut = checkOutInput.value;
            const guests = guestsSelect.value;

            if (!checkIn || !checkOut) {
                alert('Please select check-in and check-out dates');
                return;
            }

            // Show loading
            quoteDisplay.classList.remove('hidden');
            quoteLoading.classList.remove('hidden');
            quoteResult.classList.add('hidden');
            quoteError.classList.add('hidden');

            try {
                const response = await fetch(`/.netlify/functions/get-quote?checkIn=${checkIn}&checkOut=${checkOut}&guests=${guests}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Unable to get quote');
                }

                currentQuote = data;
                console.log('Quote response:', JSON.stringify(data, null, 2));

                // Format dates
                const checkInDate = new Date(checkIn + 'T00:00:00');
                const checkOutDate = new Date(checkOut + 'T00:00:00');
                const nights = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));

                const dateOptions = { month: 'short', day: 'numeric' };
                const formattedCheckIn = checkInDate.toLocaleDateString('en-US', dateOptions);
                const formattedCheckOut = checkOutDate.toLocaleDateString('en-US', dateOptions);

                // Display quote - try multiple paths to find total
                document.getElementById('quote-dates').textContent = `${formattedCheckIn} - ${formattedCheckOut} ¬∑ ${nights} night${nights > 1 ? 's' : ''}`;

                // Guesty quote response structure: rates.ratePlans[0].ratePlan.money
                const ratePlanData = data.rates?.ratePlans?.[0];
                const money = ratePlanData?.ratePlan?.money;

                // Get total price (hostPayout includes everything guest pays)
                const total = money?.hostPayout || money?.subTotalPrice || 0;

                console.log('Money object:', money);
                console.log('Extracted total:', total);

                // Store ratePlanId for booking
                if (ratePlanData?.ratePlan?._id) {
                    currentQuote.ratePlanId = ratePlanData.ratePlan._id;
                }
                document.getElementById('quote-total').textContent = `$${Math.round(total).toLocaleString()}`;
                document.getElementById('quote-breakdown').textContent = 'total including fees & taxes';

                quoteLoading.classList.add('hidden');
                quoteResult.classList.remove('hidden');

            } catch (error) {
                console.error('Quote error:', error);
                document.getElementById('quote-error-message').textContent = error.message || 'Unable to get pricing. Please try again.';
                quoteLoading.classList.add('hidden');
                quoteError.classList.remove('hidden');
            }
        });

        // Book Now - Show checkout form
        bookNowBtn.addEventListener('click', () => {
            checkoutContainer.classList.remove('hidden');
            checkoutContainer.scrollIntoView({ behavior: 'smooth' });
            initializeStripe();
            updateStayInfo(); // Populate stay info panel
        });

        // ============================================
        // STRIPE INTEGRATION
        // ============================================
        let stripe, cardElement;

        function initializeStripe() {
            if (stripe) return; // Already initialized

            stripe = Stripe('pk_live_LKZLJ4NxjahxWDx9hYlD2lNm00ZBKE4pVm');
            const elements = stripe.elements();

            cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#2D2D2D',
                        fontFamily: "'Montserrat', sans-serif",
                        '::placeholder': { color: '#A0A0A0' }
                    }
                }
            });

            cardElement.mount('#card-element');

            cardElement.on('change', (event) => {
                const displayError = document.getElementById('card-errors');
                displayError.textContent = event.error ? event.error.message : '';
            });

            // Populate checkout summary
            const checkIn = checkInInput.value;
            const checkOut = checkOutInput.value;
            const guests = guestsSelect.value;
            const money = currentQuote?.rates?.ratePlans?.[0]?.ratePlan?.money;
            const total = money?.hostPayout || money?.subTotalPrice || 0;

            document.getElementById('checkout-summary').innerHTML = `
                <div class="summary-row">
                    <span>Dates</span>
                    <span>${checkIn} to ${checkOut}</span>
                </div>
                <div class="summary-row">
                    <span>Guests</span>
                    <span>${guests}</span>
                </div>
                <div class="summary-row summary-total">
                    <span>Total</span>
                    <span>$${Math.round(total).toLocaleString()}</span>
                </div>
            `;
        }

        // Weather data by month
        const weatherByMonth = {
            0: { temp: '55¬∞F', desc: 'Cool and crisp with occasional rain. Perfect for exploring the city on foot. Pack layers!' },
            1: { temp: '60¬∞F', desc: 'Mild temperatures as Mardi Gras season heats up. Great weather for parades!' },
            2: { temp: '65¬∞F', desc: 'Beautiful spring weather. Ideal for outdoor dining and festival season.' },
            3: { temp: '72¬∞F', desc: 'Warm and pleasant - peak season for Jazz Fest. Pool weather begins!' },
            4: { temp: '80¬∞F', desc: 'Warm and humid. Perfect for pool days and evening strolls on Magazine Street.' },
            5: { temp: '85¬∞F', desc: 'Hot and humid - embrace it! Great for early morning or evening activities.' },
            6: { temp: '90¬∞F', desc: 'Peak summer heat. Stay cool by the pool during the day, explore at night.' },
            7: { temp: '90¬∞F', desc: 'Hot and steamy. AC and cold drinks are your friends. Pool is essential!' },
            8: { temp: '85¬∞F', desc: 'Still warm with occasional afternoon thunderstorms. Festival season returns!' },
            9: { temp: '75¬∞F', desc: 'Cooling off beautifully. Perfect weather for Voodoo Fest and Halloween.' },
            10: { temp: '65¬∞F', desc: 'Crisp fall air arrives. Ideal for exploring neighborhoods and outdoor dining.' },
            11: { temp: '58¬∞F', desc: 'Cool holiday season. Festive lights and celebrations throughout the city.' }
        };

        // Update stay info panel when checkout opens
        function updateStayInfo() {
            if (!selectedCheckIn || !selectedCheckOut) return;

            const checkInDate = new Date(selectedCheckIn + 'T00:00:00');
            const month = checkInDate.getMonth();

            // Update weather
            const weather = weatherByMonth[month];
            document.getElementById('stay-weather').textContent =
                `Expect temperatures around ${weather.temp}. ${weather.desc}`;

            // Update events
            const events = getEventsForRange(selectedCheckIn, selectedCheckOut);
            const eventsContainer = document.getElementById('stay-events');

            if (events.length > 0) {
                eventsContainer.innerHTML = events.slice(0, 5).map(e => `
                    <div class="stay-event-item ${e.type}">
                        <span class="stay-event-name">${e.name}</span>
                        <span class="stay-event-date">${formatEventDates(e.start, e.end)}</span>
                    </div>
                `).join('');
                if (events.length > 5) {
                    eventsContainer.innerHTML += `<p class="no-events-msg">+ ${events.length - 5} more events</p>`;
                }
            } else {
                eventsContainer.innerHTML = '<p class="no-events-msg">No major events during these dates - enjoy a quieter NOLA experience!</p>';
            }
        }

        // Add-ons calculation
        function updateAddonsTotal() {
            const checkboxes = document.querySelectorAll('.addon-item input[type="checkbox"]');
            let total = 0;
            let selectedAddons = [];

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    total += parseInt(cb.dataset.price);
                    selectedAddons.push(cb.dataset.name);
                }
            });

            const totalEl = document.getElementById('addons-total');
            const amountEl = document.getElementById('addons-total-amount');

            if (total > 0) {
                totalEl.classList.remove('hidden');
                amountEl.textContent = `$${total}`;
            } else {
                totalEl.classList.add('hidden');
            }

            return { total, selectedAddons };
        }

        // Listen for addon changes
        document.querySelectorAll('.addon-item input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', updateAddonsTotal);
        });

        // Handle checkout form submission
        const checkoutForm = document.getElementById('checkout-form');
        checkoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submit-booking');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            try {
                // Create payment method
                const { paymentMethod, error } = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        name: `${document.getElementById('guest-first-name').value} ${document.getElementById('guest-last-name').value}`,
                        email: document.getElementById('guest-email').value
                    }
                });

                if (error) {
                    throw new Error(error.message);
                }

                // Create reservation
                const response = await fetch('/.netlify/functions/create-reservation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        quoteId: currentQuote._id || currentQuote.id,
                        ratePlanId: currentQuote.ratePlanId,
                        ccToken: paymentMethod.id,
                        guest: {
                            firstName: document.getElementById('guest-first-name').value,
                            lastName: document.getElementById('guest-last-name').value,
                            email: document.getElementById('guest-email').value,
                            phone: document.getElementById('guest-phone').value
                        }
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Reservation failed');
                }

                // Show confirmation
                checkoutContainer.classList.add('hidden');
                document.getElementById('booking-confirmation').classList.remove('hidden');
                document.getElementById('confirmation-details').innerHTML = `
                    <p><strong>Confirmation:</strong> ${result.reservation.confirmationCode || result.reservation._id}</p>
                    <p><strong>Dates:</strong> ${checkInInput.value} to ${checkOutInput.value}</p>
                `;

            } catch (error) {
                console.error('Booking error:', error);
                alert(error.message || 'Unable to complete booking. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Confirm Reservation';
            }
        });

        // ============================================
        // PARALLAX EFFECTS
        // ============================================
        window.addEventListener('scroll', () => {
            const scrolled = window.pageYOffset;

            // Parallax for invitation background
            const invitationBg = document.querySelector('.invitation-bg');
            if (invitationBg) {
                invitationBg.style.transform = `translateY(${scrolled * 0.5}px)`;
            }

            // Parallax for water background
            const waterBg = document.querySelector('.water-bg img');
            if (waterBg) {
                const waterSection = document.querySelector('.scene-water');
                const waterRect = waterSection.getBoundingClientRect();
                if (waterRect.top < window.innerHeight && waterRect.bottom > 0) {
                    const progress = (window.innerHeight - waterRect.top) / (window.innerHeight + waterRect.height);
                    waterBg.style.transform = `translateY(${progress * -100}px) scale(1.1)`;
                }
            }
        }, { passive: true });
    </script>
</body>
</html>
